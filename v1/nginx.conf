http {
    js_import /etc/nginx/njs/saml_check.js;

    server {
        listen 443 ssl;
        server_name github.yourcompany.com;

        # Ensure body is captured
        client_max_body_size 10M;
        client_body_buffer_size 128k;

        # The public SAML endpoint
        location = /saml/consume {
            # This forces Nginx to read the body before calling njs
            mirror /_null; 
            js_content saml_check.validateUser;
        }

        # The actual GitHub Proxy (Internal Only)
        location = /_github_upstream {
            internal;
            proxy_pass https://github-enterprise-backend/saml/consume;
            proxy_set_header Host $host;
            # Ensure other headers are passed
        }

        # The External API Check (Internal Only)
        location = /_validate_email {
            internal;
            proxy_pass https://api.yourcompany.com/user/mail;
            proxy_set_header Content-Length "";
        }
    }
}
