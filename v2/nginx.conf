load_module modules/ngx_http_js_module.so;

worker_processes auto;

events {}

http {
    # njs settings
    js_fetch_timeout 2s;

    # Import JS logic
    js_import saml from /etc/nginx/njs/saml.js;

    server {
        listen 443 ssl;
        server_name github-proxy.company.com;

        # SSL config omitted for clarity
        # ssl_certificate ...
        # ssl_certificate_key ...

        # Entry point used by IdP
        location = /saml/consume {
            js_content saml.saml_gate;
        }

        # Internal forward to GitHub Enterprise
        location @github_saml {
            proxy_pass https://github-enterprise.internal/saml/consume;

            proxy_set_header Host github-enterprise.internal;
            proxy_set_header X-Forwarded-For $remote_addr;

            # VERY IMPORTANT â†’ forward body unchanged
            proxy_pass_request_body on;
            proxy_set_header Content-Length $content_length;
        }
    }
}
